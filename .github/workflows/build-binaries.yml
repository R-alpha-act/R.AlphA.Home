name: Build R Package Binaries

on:
  push:
    branches:
      - main
  release:
    types: [published]
  workflow_dispatch:
    inputs:
      upload:
        description: 'Upload binaries to FTP'
        required: false
        default: 'true'
        type: boolean

jobs:
  # ============================================================================
  # Build Windows Binary (multiple R versions)
  # ============================================================================
  build-windows:
    runs-on: windows-latest
    strategy:
      matrix:
        r-version: ['4.2', '4.4', '4.5']
      fail-fast: false

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup R ${{ matrix.r-version }}
        uses: r-lib/actions/setup-r@v2
        with:
          r-version: ${{ matrix.r-version }}

      # ----------------------------------------------------------------
      # Cache des dépendances R (r-lib)
      # ----------------------------------------------------------------
      # - Clé de cache : OS + R version + hash(DESCRIPTION)
      # - Premier run : installe tout (~10-20 min), sauvegarde en cache
      # - Runs suivants : restaure le cache (~30s), skip installation
      # - Invalidé auto si DESCRIPTION change (nouvelle dépendance)
      # ----------------------------------------------------------------
      - name: Install dependencies (with cache)
        uses: r-lib/actions/setup-r-dependencies@v2
        with:
          cache-version: 2
          extra-packages: any::rcmdcheck
          # pak-version devel : version dev de pak, plus robuste pour R 4.5+
          # (la version stable peut avoir des bugs avec les nouvelles versions R)
          pak-version: devel
          # upgrade TRUE : force la mise à jour des packages même si une
          # version est déjà installée (évite les conflits de versions)
          upgrade: 'TRUE'
          # lockfile false : ne pas utiliser .github/pkg.lock
          # (le repo client est généré, pas de lockfile versionné)
          # Sans ça : erreur "cannot open connection" sur pkg.lock inexistant
          lockfile: false
          # Utiliser ralpha.fr/repo en priorité (Home à jour) avant CRAN
          repos: |
            https://ralpha.fr/repo
            https://cloud.r-project.org

      - name: Build binary package
        id: build
        run: |
          R CMD INSTALL --build .
          for %%f in (*.zip) do echo binary_name=%%f >> %GITHUB_OUTPUT%
        shell: cmd

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: windows-R${{ matrix.r-version }}
          path: "*.zip"
          retention-days: 30

  # ============================================================================
  # Build macOS Binary (ARM64 / Apple Silicon) - multiple R versions
  # ============================================================================
  build-macos-arm:
    runs-on: macos-latest
    strategy:
      matrix:
        r-version: ['4.2', '4.4', '4.5']
      fail-fast: false

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup R ${{ matrix.r-version }}
        uses: r-lib/actions/setup-r@v2
        with:
          r-version: ${{ matrix.r-version }}

      # ----------------------------------------------------------------
      # Cache des dépendances R (r-lib)
      # ----------------------------------------------------------------
      # - Clé de cache : OS + R version + hash(DESCRIPTION)
      # - Premier run : installe tout (~10-20 min), sauvegarde en cache
      # - Runs suivants : restaure le cache (~30s), skip installation
      # - Invalidé auto si DESCRIPTION change (nouvelle dépendance)
      # ----------------------------------------------------------------
      - name: Install dependencies (with cache)
        uses: r-lib/actions/setup-r-dependencies@v2
        with:
          cache-version: 2
          extra-packages: any::rcmdcheck
          # pak-version devel : version dev de pak, plus robuste pour R 4.5+
          # (la version stable peut avoir des bugs avec les nouvelles versions R)
          pak-version: devel
          # upgrade TRUE : force la mise à jour des packages même si une
          # version est déjà installée (évite les conflits de versions)
          upgrade: 'TRUE'
          # lockfile false : ne pas utiliser .github/pkg.lock
          # (le repo client est généré, pas de lockfile versionné)
          # Sans ça : erreur "cannot open connection" sur pkg.lock inexistant
          lockfile: false
          # Utiliser ralpha.fr/repo en priorité (Home à jour) avant CRAN
          repos: |
            https://ralpha.fr/repo
            https://cloud.r-project.org

      - name: Build binary package
        id: build
        run: |
          R CMD INSTALL --build .
          BINARY=$(ls *.tgz 2>/dev/null | head -1)
          echo "binary_name=$BINARY" >> $GITHUB_OUTPUT
          echo "Built: $BINARY"

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: macos-arm-R${{ matrix.r-version }}
          path: "*.tgz"
          retention-days: 30

  # ============================================================================
  # Build macOS Binary (Intel x86_64) - multiple R versions
  # ============================================================================
  # NOTE: macos-12 retiré (déc 2024), macos-13 retiré (déc 2025)
  # Pour Intel, utiliser: macos-15-large, macos-14-large, ou macos-15-intel
  # Apple a arrêté le support Intel — GitHub retirera les runners Intel automne 2027
  # ============================================================================
  build-macos-intel:
    runs-on: macos-15-large  # Intel x86_64 runner
    strategy:
      matrix:
        r-version: ['4.2', '4.4', '4.5']
      fail-fast: false

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup R ${{ matrix.r-version }}
        uses: r-lib/actions/setup-r@v2
        with:
          r-version: ${{ matrix.r-version }}

      # ----------------------------------------------------------------
      # Cache des dépendances R (r-lib)
      # ----------------------------------------------------------------
      # - Clé de cache : OS + R version + hash(DESCRIPTION)
      # - Premier run : installe tout (~10-20 min), sauvegarde en cache
      # - Runs suivants : restaure le cache (~30s), skip installation
      # - Invalidé auto si DESCRIPTION change (nouvelle dépendance)
      # ----------------------------------------------------------------
      - name: Install dependencies (with cache)
        uses: r-lib/actions/setup-r-dependencies@v2
        with:
          cache-version: 2
          extra-packages: any::rcmdcheck
          # pak-version devel : version dev de pak, plus robuste pour R 4.5+
          # (la version stable peut avoir des bugs avec les nouvelles versions R)
          pak-version: devel
          # upgrade TRUE : force la mise à jour des packages même si une
          # version est déjà installée (évite les conflits de versions)
          upgrade: 'TRUE'
          # lockfile false : ne pas utiliser .github/pkg.lock
          # (le repo client est généré, pas de lockfile versionné)
          # Sans ça : erreur "cannot open connection" sur pkg.lock inexistant
          lockfile: false
          # Utiliser ralpha.fr/repo en priorité (Home à jour) avant CRAN
          repos: |
            https://ralpha.fr/repo
            https://cloud.r-project.org

      - name: Build binary package
        id: build
        run: |
          R CMD INSTALL --build .
          BINARY=$(ls *.tgz 2>/dev/null | head -1)
          echo "binary_name=$BINARY" >> $GITHUB_OUTPUT
          echo "Built: $BINARY (Intel x86_64)"

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: macos-intel-R${{ matrix.r-version }}
          path: "*.tgz"
          retention-days: 30

  # ============================================================================
  # Upload to FTP (ralpha.fr/repo) and Update PACKAGES Index
  # ============================================================================
  upload-to-ftp:
    needs: [build-windows, build-macos-arm, build-macos-intel]
    runs-on: ubuntu-latest
    if: (!cancelled()) && (github.event_name == 'release' || github.event_name == 'push' || github.event.inputs.upload == 'true')

    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts/

      - name: Setup R for index generation
        uses: r-lib/actions/setup-r@v2
        with:
          # ⚠️ Must be a single version (string), NOT a list!
          # This step just generates PACKAGES index files, any R version works
          r-version: '4.4'

      - name: Download existing repo from FTP
        run: |
          # Install lftp
          sudo apt-get update && sudo apt-get install -y lftp

          # Download existing repo structure
          lftp -c "set ftp:ssl-allow no; open -u ${{ secrets.FTP_USER }},${{ secrets.FTP_PASSWORD }} ${{ secrets.FTP_HOST }}; mirror --verbose / existing_repo" || echo "No existing repo or connection failed"

      - name: Organize files into CRAN structure
        run: |
          mkdir -p repo

          # Copy existing repo content first (if exists)
          if [ -d "existing_repo" ]; then
            echo "=== Merging with existing repo ==="
            cp -r existing_repo/* repo/ 2>/dev/null || true
          fi

          # Organize Windows binaries (NEW builds)
          for R_VER in 4.2 4.4 4.5; do
            DIR="artifacts/windows-R${R_VER}"
            if [ -d "$DIR" ]; then
              mkdir -p "repo/bin/windows/contrib/${R_VER}"
              cp "$DIR"/*.zip "repo/bin/windows/contrib/${R_VER}/" 2>/dev/null || true
            fi
          done

          # Organize macOS ARM binaries (NEW builds)
          for R_VER in 4.2 4.4 4.5; do
            DIR="artifacts/macos-arm-R${R_VER}"
            if [ -d "$DIR" ]; then
              mkdir -p "repo/bin/macosx/big-sur-arm64/contrib/${R_VER}"
              cp "$DIR"/*.tgz "repo/bin/macosx/big-sur-arm64/contrib/${R_VER}/" 2>/dev/null || true
            fi
          done

          # Organize macOS Intel binaries (NEW builds)
          for R_VER in 4.2 4.4 4.5; do
            DIR="artifacts/macos-intel-R${R_VER}"
            if [ -d "$DIR" ]; then
              mkdir -p "repo/bin/macosx/big-sur-x86_64/contrib/${R_VER}"
              cp "$DIR"/*.tgz "repo/bin/macosx/big-sur-x86_64/contrib/${R_VER}/" 2>/dev/null || true
            fi
          done

          echo "=== Repository structure ==="
          find repo -type f | head -50

      - name: Generate PACKAGES index files (for ALL packages)
        run: |
          for R_VER in 4.2 4.4 4.5; do
            echo "=== Generating PACKAGES for R ${R_VER} ==="

            # Windows - regenerate index with ALL binaries present
            WIN_DIR="repo/bin/windows/contrib/${R_VER}"
            if [ -d "$WIN_DIR" ] && ls "$WIN_DIR"/*.zip 1>/dev/null 2>&1; then
              Rscript -e "tools::write_PACKAGES('${WIN_DIR}', type='win.binary')"
              echo "  Windows R${R_VER}: $(ls -1 $WIN_DIR/*.zip | wc -l) packages"
              echo "  Packages: $(ls -1 $WIN_DIR/*.zip | xargs -n1 basename)"
            fi

            # macOS ARM - regenerate index with ALL binaries present
            MAC_ARM_DIR="repo/bin/macosx/big-sur-arm64/contrib/${R_VER}"
            if [ -d "$MAC_ARM_DIR" ] && ls "$MAC_ARM_DIR"/*.tgz 1>/dev/null 2>&1; then
              Rscript -e "tools::write_PACKAGES('${MAC_ARM_DIR}', type='mac.binary')"
              echo "  macOS ARM R${R_VER}: $(ls -1 $MAC_ARM_DIR/*.tgz | wc -l) packages"
              echo "  Packages: $(ls -1 $MAC_ARM_DIR/*.tgz | xargs -n1 basename)"
            fi

            # macOS Intel - regenerate index with ALL binaries present
            MAC_INTEL_DIR="repo/bin/macosx/big-sur-x86_64/contrib/${R_VER}"
            if [ -d "$MAC_INTEL_DIR" ] && ls "$MAC_INTEL_DIR"/*.tgz 1>/dev/null 2>&1; then
              Rscript -e "tools::write_PACKAGES('${MAC_INTEL_DIR}', type='mac.binary')"
              echo "  macOS Intel R${R_VER}: $(ls -1 $MAC_INTEL_DIR/*.tgz | wc -l) packages"
              echo "  Packages: $(ls -1 $MAC_INTEL_DIR/*.tgz | xargs -n1 basename)"
            fi
          done

      - name: Upload to FTP
        run: |
          # Install lftp (more reliable than basic FTP)
          sudo apt-get update && sudo apt-get install -y lftp

          # Export credentials first
          export FTP_HOST="${{ secrets.FTP_HOST }}"
          export FTP_USER="${{ secrets.FTP_USER }}"
          export FTP_PASSWORD="${{ secrets.FTP_PASSWORD }}"
          export FTP_PATH="/"

          # Create lftp script (heredoc without quotes allows variable expansion)
          cat > upload.lftp << LFTP_SCRIPT
          set ftp:ssl-allow no
          set net:timeout 30
          set net:max-retries 3
          open -u $FTP_USER,$FTP_PASSWORD $FTP_HOST
          cd $FTP_PATH
          mirror --reverse --verbose repo/ .
          bye
          LFTP_SCRIPT

          # Execute upload
          lftp -f upload.lftp
          echo "Upload complete!"

      - name: Summary
        run: |
          echo "## Build Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Packages built:" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Platform | R Version | Package |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|-----------|---------|" >> $GITHUB_STEP_SUMMARY
          for f in $(find repo -name "*.zip" -o -name "*.tgz" | sort); do
            PLATFORM=$(echo $f | grep -q windows && echo "Windows" || echo "macOS ARM")
            R_VER=$(echo $f | grep -oP 'contrib/\K[0-9.]+')
            PKG=$(basename $f)
            echo "| $PLATFORM | $R_VER | $PKG |" >> $GITHUB_STEP_SUMMARY
          done
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Uploaded to: \`https://ralpha.fr/repo\`" >> $GITHUB_STEP_SUMMARY
