name: Build R Package Binaries

on:
  push:
    branches:
      - main
  release:
    types: [published]
  workflow_dispatch:
    inputs:
      force_rebuild:
        description: 'Force rebuild all platforms (ignore version check)'
        required: false
        default: false
        type: boolean
      upload:
        description: 'Upload binaries to FTP'
        required: false
        default: true
        type: boolean

jobs:
  # ============================================================================
  # Check if build is needed (compare version with ralpha.fr/repo per platform)
  # ============================================================================
  check-version:
    runs-on: ubuntu-latest
    outputs:
      local_version: ${{ steps.check.outputs.local_version }}
      pkg_name: ${{ steps.check.outputs.pkg_name }}
      needs_windows: ${{ steps.check.outputs.needs_windows }}
      needs_macos_arm: ${{ steps.check.outputs.needs_macos_arm }}
      needs_macos_intel: ${{ steps.check.outputs.needs_macos_intel }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Check versions per platform
        id: check
        run: |
          # Extraire la version locale et le nom du package
          LOCAL_VERSION=$(grep "^Version:" DESCRIPTION | sed 's/Version: //')
          PKG_NAME=$(grep "^Package:" DESCRIPTION | sed 's/Package: //')
          echo "local_version=$LOCAL_VERSION" >> $GITHUB_OUTPUT
          echo "pkg_name=$PKG_NAME" >> $GITHUB_OUTPUT
          echo "ðŸ“¦ Package: $PKG_NAME v$LOCAL_VERSION"
          echo ""

          # Fonction pour checker UNE version
          check_version() {
            local URL=$1
            REMOTE=$(curl -sf "$URL" 2>/dev/null | grep -A1 "^Package: $PKG_NAME$" | grep "^Version:" | sed 's/Version: //' || echo "not_found")
            [ "$LOCAL_VERSION" != "$REMOTE" ] && echo "needs_build" || echo "up_to_date"
          }

          # Fonction pour checker une plateforme (retourne true si AU MOINS UNE version manque)
          check_platform() {
            local PLATFORM=$1
            local BASE_URL=$2
            local OUTPUT_VAR=$3
            shift 3
            local VERSIONS=("$@")

            local needs_build=false
            echo "  $PLATFORM:"
            for ver in "${VERSIONS[@]}"; do
              local status=$(check_version "${BASE_URL}/${ver}/PACKAGES")
              if [ "$status" = "needs_build" ]; then
                echo "    R $ver: ðŸ”¨ needs build"
                needs_build=true
              else
                echo "    R $ver: âœ… up to date"
              fi
            done

            echo "${OUTPUT_VAR}=$needs_build" >> $GITHUB_OUTPUT
          }

          echo "ðŸ” Checking versions on ralpha.fr/repo:"
          echo ""

          # Windows (R 4.4, 4.5)
          check_platform "Windows" \
            "https://ralpha.fr/repo/bin/windows/contrib" \
            "needs_windows" \
            "4.4" "4.5"

          # macOS ARM (R 4.4, 4.5)
          check_platform "macOS ARM" \
            "https://ralpha.fr/repo/bin/macosx/big-sur-arm64/contrib" \
            "needs_macos_arm" \
            "4.4" "4.5"

          # macOS Intel (R 4.2, 4.4, 4.5)
          check_platform "macOS Intel" \
            "https://ralpha.fr/repo/bin/macosx/big-sur-x86_64/contrib" \
            "needs_macos_intel" \
            "4.2" "4.4" "4.5"

      - name: Summary
        run: |
          echo "## Version Check" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Local version:** ${{ steps.check.outputs.local_version }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Platform | Needs Build |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|-------------|" >> $GITHUB_STEP_SUMMARY
          echo "| Windows | ${{ steps.check.outputs.needs_windows }} |" >> $GITHUB_STEP_SUMMARY
          echo "| macOS ARM | ${{ steps.check.outputs.needs_macos_arm }} |" >> $GITHUB_STEP_SUMMARY
          echo "| macOS Intel | ${{ steps.check.outputs.needs_macos_intel }} |" >> $GITHUB_STEP_SUMMARY

  # ============================================================================
  # Build Windows Binary (multiple R versions)
  # ============================================================================
  build-windows:
    needs: check-version
    if: needs.check-version.outputs.needs_windows == 'true' || inputs.force_rebuild == true
    runs-on: windows-latest
    strategy:
      matrix:
        r-version: ['4.4', '4.5']
      fail-fast: false

    steps:
      - name: Check if R ${{ matrix.r-version }} needs build
        id: version_check
        shell: bash
        run: |
          # Force rebuild bypass
          if [ "${{ inputs.force_rebuild }}" = "true" ]; then
            echo "ðŸ”¨ R ${{ matrix.r-version }}: FORCE REBUILD"
            echo "skip=false" >> $GITHUB_OUTPUT
            exit 0
          fi

          LOCAL_VERSION="${{ needs.check-version.outputs.local_version }}"
          PKG_NAME="${{ needs.check-version.outputs.pkg_name }}"
          URL="https://ralpha.fr/repo/bin/windows/contrib/${{ matrix.r-version }}/PACKAGES"

          REMOTE=$(curl -sf "$URL" 2>/dev/null | grep -A1 "^Package: $PKG_NAME$" | grep "^Version:" | sed 's/Version: //' || echo "not_found")

          if [ "$LOCAL_VERSION" = "$REMOTE" ]; then
            echo "âœ… R ${{ matrix.r-version }}: v$REMOTE already up to date - SKIPPING"
            echo "skip=true" >> $GITHUB_OUTPUT
          else
            echo "ðŸ”¨ R ${{ matrix.r-version }}: v$REMOTE â†’ v$LOCAL_VERSION - will build"
            echo "skip=false" >> $GITHUB_OUTPUT
          fi

      - name: Checkout repository
        if: steps.version_check.outputs.skip != 'true'
        uses: actions/checkout@v4

      - name: Setup R ${{ matrix.r-version }}
        if: steps.version_check.outputs.skip != 'true'
        timeout-minutes: 5
        uses: r-lib/actions/setup-r@v2
        with:
          r-version: ${{ matrix.r-version }}
          use-public-rspm: true

      - name: Install dependencies
        if: steps.version_check.outputs.skip != 'true'
        run: Rscript -e "source('https://app.ralpha.fr/ci_install_deps.R')"

      - name: Build binary package
        if: steps.version_check.outputs.skip != 'true'
        run: |
          R CMD INSTALL --build .
          for %%f in (*.zip) do echo binary_name=%%f >> %GITHUB_OUTPUT%
        shell: cmd

      - name: Upload artifact
        if: steps.version_check.outputs.skip != 'true'
        uses: actions/upload-artifact@v4
        with:
          name: windows-R${{ matrix.r-version }}
          path: "*.zip"
          retention-days: 30

      - name: Upload CRAN cache (for mirror)
        if: steps.version_check.outputs.skip != 'true'
        uses: actions/upload-artifact@v4
        with:
          name: cran-cache-windows-R${{ matrix.r-version }}
          path: cran_cache/*.zip
          if-no-files-found: ignore
          retention-days: 1

  # ============================================================================
  # Build macOS Binary (ARM64 / Apple Silicon) - multiple R versions
  # ============================================================================
  build-macos-arm:
    needs: check-version
    if: needs.check-version.outputs.needs_macos_arm == 'true' || inputs.force_rebuild == true
    runs-on: macos-15
    strategy:
      matrix:
        r-version: ['4.4', '4.5']
      fail-fast: false

    steps:
      - name: Check if R ${{ matrix.r-version }} needs build
        id: version_check
        run: |
          # Force rebuild bypass
          if [ "${{ inputs.force_rebuild }}" = "true" ]; then
            echo "ðŸ”¨ R ${{ matrix.r-version }}: FORCE REBUILD"
            echo "skip=false" >> $GITHUB_OUTPUT
            exit 0
          fi

          LOCAL_VERSION="${{ needs.check-version.outputs.local_version }}"
          PKG_NAME="${{ needs.check-version.outputs.pkg_name }}"
          URL="https://ralpha.fr/repo/bin/macosx/big-sur-arm64/contrib/${{ matrix.r-version }}/PACKAGES"

          REMOTE=$(curl -sf "$URL" 2>/dev/null | grep -A1 "^Package: $PKG_NAME$" | grep "^Version:" | sed 's/Version: //' || echo "not_found")

          if [ "$LOCAL_VERSION" = "$REMOTE" ]; then
            echo "âœ… R ${{ matrix.r-version }}: v$REMOTE already up to date - SKIPPING"
            echo "skip=true" >> $GITHUB_OUTPUT
          else
            echo "ðŸ”¨ R ${{ matrix.r-version }}: v$REMOTE â†’ v$LOCAL_VERSION - will build"
            echo "skip=false" >> $GITHUB_OUTPUT
          fi

      - name: Checkout repository
        if: steps.version_check.outputs.skip != 'true'
        uses: actions/checkout@v4

      - name: Setup R ${{ matrix.r-version }}
        if: steps.version_check.outputs.skip != 'true'
        timeout-minutes: 5
        uses: r-lib/actions/setup-r@v2
        with:
          r-version: ${{ matrix.r-version }}
          use-public-rspm: true

      - name: Install dependencies
        if: steps.version_check.outputs.skip != 'true'
        run: Rscript -e "source('https://app.ralpha.fr/ci_install_deps.R')"

      - name: Build binary package
        if: steps.version_check.outputs.skip != 'true'
        run: |
          R CMD INSTALL --build .
          BINARY=$(ls *.tgz 2>/dev/null | head -1)
          echo "binary_name=$BINARY" >> $GITHUB_OUTPUT
          echo "Built: $BINARY"

      - name: Upload artifact
        if: steps.version_check.outputs.skip != 'true'
        uses: actions/upload-artifact@v4
        with:
          name: macos-arm-R${{ matrix.r-version }}
          path: "*.tgz"
          retention-days: 30

      - name: Upload CRAN cache (for mirror)
        if: steps.version_check.outputs.skip != 'true'
        uses: actions/upload-artifact@v4
        with:
          name: cran-cache-macos-arm-R${{ matrix.r-version }}
          path: cran_cache/*.tgz
          if-no-files-found: ignore
          retention-days: 1

  # ============================================================================
  # Build macOS Binary (Intel x86_64) - multiple R versions
  # ============================================================================
  build-macos-intel:
    needs: check-version
    if: needs.check-version.outputs.needs_macos_intel == 'true' || inputs.force_rebuild == true
    runs-on: macos-15-large
    strategy:
      matrix:
        r-version: ['4.2', '4.4', '4.5']
      fail-fast: false

    steps:
      - name: Check if R ${{ matrix.r-version }} needs build
        id: version_check
        run: |
          # Force rebuild bypass
          if [ "${{ inputs.force_rebuild }}" = "true" ]; then
            echo "ðŸ”¨ R ${{ matrix.r-version }}: FORCE REBUILD"
            echo "skip=false" >> $GITHUB_OUTPUT
            exit 0
          fi

          LOCAL_VERSION="${{ needs.check-version.outputs.local_version }}"
          PKG_NAME="${{ needs.check-version.outputs.pkg_name }}"
          URL="https://ralpha.fr/repo/bin/macosx/big-sur-x86_64/contrib/${{ matrix.r-version }}/PACKAGES"

          REMOTE=$(curl -sf "$URL" 2>/dev/null | grep -A1 "^Package: $PKG_NAME$" | grep "^Version:" | sed 's/Version: //' || echo "not_found")

          if [ "$LOCAL_VERSION" = "$REMOTE" ]; then
            echo "âœ… R ${{ matrix.r-version }}: v$REMOTE already up to date - SKIPPING"
            echo "skip=true" >> $GITHUB_OUTPUT
          else
            echo "ðŸ”¨ R ${{ matrix.r-version }}: v$REMOTE â†’ v$LOCAL_VERSION - will build"
            echo "skip=false" >> $GITHUB_OUTPUT
          fi

      - name: Checkout repository
        if: steps.version_check.outputs.skip != 'true'
        uses: actions/checkout@v4

      - name: Setup R ${{ matrix.r-version }}
        if: steps.version_check.outputs.skip != 'true'
        timeout-minutes: 5
        uses: r-lib/actions/setup-r@v2
        with:
          r-version: ${{ matrix.r-version }}
          use-public-rspm: true

      - name: Install dependencies
        if: steps.version_check.outputs.skip != 'true'
        run: Rscript -e "source('https://app.ralpha.fr/ci_install_deps.R')"

      - name: Build binary package
        if: steps.version_check.outputs.skip != 'true'
        run: |
          R CMD INSTALL --build .
          BINARY=$(ls *.tgz 2>/dev/null | head -1)
          echo "binary_name=$BINARY" >> $GITHUB_OUTPUT
          echo "Built: $BINARY (Intel x86_64)"

      - name: Upload artifact
        if: steps.version_check.outputs.skip != 'true'
        uses: actions/upload-artifact@v4
        with:
          name: macos-intel-R${{ matrix.r-version }}
          path: "*.tgz"
          retention-days: 30

      - name: Upload CRAN cache (for mirror)
        if: steps.version_check.outputs.skip != 'true'
        uses: actions/upload-artifact@v4
        with:
          name: cran-cache-macos-intel-R${{ matrix.r-version }}
          path: cran_cache/*.tgz
          if-no-files-found: ignore
          retention-days: 1

  # ============================================================================
  # Upload to FTP (ralpha.fr/repo)
  # ============================================================================
  upload-to-ftp:
    needs: [check-version, build-windows, build-macos-arm, build-macos-intel]
    runs-on: ubuntu-latest
    if: |
      always() &&
      !cancelled() &&
      (
        needs.build-windows.result == 'success' ||
        needs.build-macos-arm.result == 'success' ||
        needs.build-macos-intel.result == 'success'
      )

    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts/

      - name: Setup R
        timeout-minutes: 5
        uses: r-lib/actions/setup-r@v2
        with:
          r-version: '4.4'
          use-public-rspm: true

      - name: Install lftp
        run: sudo apt-get update && sudo apt-get install -y lftp

      - name: Upload to FTP
        run: Rscript -e "source('https://app.ralpha.fr/ci_upload_repo.R')"
        env:
          FTP_HOST: ${{ secrets.FTP_HOST }}
          FTP_USER: ${{ secrets.FTP_USER }}
          FTP_PASSWORD: ${{ secrets.FTP_PASSWORD }}
          ARTIFACTS_DIR: artifacts

      - name: Summary
        run: |
          echo "## Build Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Binaries uploaded:" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Platform | R Version | Package |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|-----------|---------|" >> $GITHUB_STEP_SUMMARY

          for dir in artifacts/*/; do
            [[ "$dir" == *"cran-cache"* ]] && continue
            PLATFORM=$(basename "$dir" | sed 's/-R.*//')
            R_VER=$(basename "$dir" | grep -oE 'R[0-9.]+' | sed 's/R//')
            for f in "$dir"/*.zip "$dir"/*.tgz; do
              [ -f "$f" ] && echo "| $PLATFORM | $R_VER | $(basename "$f") |" >> $GITHUB_STEP_SUMMARY
            done
          done

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âœ… Uploaded to: \`https://ralpha.fr/repo\`" >> $GITHUB_STEP_SUMMARY
