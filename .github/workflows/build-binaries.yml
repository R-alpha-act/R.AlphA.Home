name: Build R Package Binaries

on:
  push:
    branches:
      - main
  release:
    types: [published]
  workflow_dispatch:
    inputs:
      upload:
        description: 'Upload binaries to FTP'
        required: false
        default: 'true'
        type: boolean

jobs:
  # ============================================================================
  # Check if build is needed (compare version with ralpha.fr/repo per platform)
  # ============================================================================
  check-version:
    runs-on: ubuntu-latest
    outputs:
      local_version: ${{ steps.check.outputs.local_version }}
      needs_windows: ${{ steps.check.outputs.needs_windows }}
      needs_macos_arm: ${{ steps.check.outputs.needs_macos_arm }}
      needs_macos_intel: ${{ steps.check.outputs.needs_macos_intel }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Check versions per platform
        id: check
        run: |
          # Extraire la version locale et le nom du package
          LOCAL_VERSION=$(grep "^Version:" DESCRIPTION | sed 's/Version: //')
          PKG_NAME=$(grep "^Package:" DESCRIPTION | sed 's/Package: //')
          echo "local_version=$LOCAL_VERSION" >> $GITHUB_OUTPUT
          echo "ðŸ“¦ Package: $PKG_NAME v$LOCAL_VERSION"
          echo ""

          # Fonction pour checker une plateforme
          check_platform() {
            local PLATFORM=$1
            local URL=$2
            local OUTPUT_VAR=$3

            REMOTE=$(curl -sf "$URL" 2>/dev/null | grep -A1 "^Package: $PKG_NAME$" | grep "^Version:" | sed 's/Version: //' || echo "not_found")

            if [ "$LOCAL_VERSION" = "$REMOTE" ]; then
              echo "  âœ… $PLATFORM: v$REMOTE (up to date)"
              echo "${OUTPUT_VAR}=false" >> $GITHUB_OUTPUT
            else
              echo "  ðŸ”¨ $PLATFORM: v$REMOTE â†’ v$LOCAL_VERSION (needs build)"
              echo "${OUTPUT_VAR}=true" >> $GITHUB_OUTPUT
            fi
          }

          echo "ðŸ” Checking versions on ralpha.fr/repo:"
          echo ""

          # Windows (check 4.4 as reference)
          check_platform "Windows" \
            "https://ralpha.fr/repo/bin/windows/contrib/4.4/PACKAGES" \
            "needs_windows"

          # macOS ARM (check 4.4 as reference)
          check_platform "macOS ARM" \
            "https://ralpha.fr/repo/bin/macosx/big-sur-arm64/contrib/4.4/PACKAGES" \
            "needs_macos_arm"

          # macOS Intel (check 4.2 - the only version we build)
          check_platform "macOS Intel" \
            "https://ralpha.fr/repo/bin/macosx/big-sur-x86_64/contrib/4.2/PACKAGES" \
            "needs_macos_intel"

      - name: Summary
        run: |
          echo "## Version Check" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Local version:** ${{ steps.check.outputs.local_version }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Platform | Needs Build |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|-------------|" >> $GITHUB_STEP_SUMMARY
          echo "| Windows | ${{ steps.check.outputs.needs_windows }} |" >> $GITHUB_STEP_SUMMARY
          echo "| macOS ARM | ${{ steps.check.outputs.needs_macos_arm }} |" >> $GITHUB_STEP_SUMMARY
          echo "| macOS Intel | ${{ steps.check.outputs.needs_macos_intel }} |" >> $GITHUB_STEP_SUMMARY

  # ============================================================================
  # Build Windows Binary (multiple R versions)
  # ============================================================================
  build-windows:
    needs: check-version
    if: needs.check-version.outputs.needs_windows == 'true' || github.event_name == 'workflow_dispatch'
    runs-on: windows-latest
    strategy:
      matrix:
        r-version: ['4.2', '4.4', '4.5']
      fail-fast: false

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup R ${{ matrix.r-version }}
        uses: r-lib/actions/setup-r@v2
        with:
          r-version: ${{ matrix.r-version }}

      # ----------------------------------------------------------------
      # Cache des dÃ©pendances R (r-lib)
      # ----------------------------------------------------------------
      # - ClÃ© de cache : OS + R version + hash(DESCRIPTION)
      # - Premier run : installe tout (~10-20 min), sauvegarde en cache
      # - Runs suivants : restaure le cache (~30s), skip installation
      # - InvalidÃ© auto si DESCRIPTION change (nouvelle dÃ©pendance)
      # ----------------------------------------------------------------
      - name: Install dependencies (with cache)
        uses: r-lib/actions/setup-r-dependencies@v2
        with:
          cache-version: 2
          extra-packages: any::rcmdcheck
          # pak-version devel : version dev de pak, plus robuste pour R 4.5+
          # (la version stable peut avoir des bugs avec les nouvelles versions R)
          pak-version: devel
          # upgrade TRUE : force la mise Ã  jour des packages mÃªme si une
          # version est dÃ©jÃ  installÃ©e (Ã©vite les conflits de versions)
          upgrade: 'TRUE'
          # lockfile false : ne pas utiliser .github/pkg.lock
          # (le repo client est gÃ©nÃ©rÃ©, pas de lockfile versionnÃ©)
          # Sans Ã§a : erreur "cannot open connection" sur pkg.lock inexistant
          lockfile: false
          # Utiliser ralpha.fr/repo en prioritÃ© (Home Ã  jour) avant CRAN
          repos: |
            https://ralpha.fr/repo
            https://cloud.r-project.org

      - name: Build binary package
        id: build
        run: |
          R CMD INSTALL --build .
          for %%f in (*.zip) do echo binary_name=%%f >> %GITHUB_OUTPUT%
        shell: cmd

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: windows-R${{ matrix.r-version }}
          path: "*.zip"
          retention-days: 30

  # ============================================================================
  # Build macOS Binary (ARM64 / Apple Silicon) - multiple R versions
  # ============================================================================
  build-macos-arm:
    needs: check-version
    if: needs.check-version.outputs.needs_macos_arm == 'true' || github.event_name == 'workflow_dispatch'
    runs-on: macos-latest
    strategy:
      matrix:
        r-version: ['4.2', '4.4', '4.5']
      fail-fast: false

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup R ${{ matrix.r-version }}
        uses: r-lib/actions/setup-r@v2
        with:
          r-version: ${{ matrix.r-version }}

      # ----------------------------------------------------------------
      # Cache des dÃ©pendances R (r-lib)
      # ----------------------------------------------------------------
      # - ClÃ© de cache : OS + R version + hash(DESCRIPTION)
      # - Premier run : installe tout (~10-20 min), sauvegarde en cache
      # - Runs suivants : restaure le cache (~30s), skip installation
      # - InvalidÃ© auto si DESCRIPTION change (nouvelle dÃ©pendance)
      # ----------------------------------------------------------------
      - name: Install dependencies (with cache)
        uses: r-lib/actions/setup-r-dependencies@v2
        with:
          cache-version: 2
          extra-packages: any::rcmdcheck
          # pak-version devel : version dev de pak, plus robuste pour R 4.5+
          # (la version stable peut avoir des bugs avec les nouvelles versions R)
          pak-version: devel
          # upgrade TRUE : force la mise Ã  jour des packages mÃªme si une
          # version est dÃ©jÃ  installÃ©e (Ã©vite les conflits de versions)
          upgrade: 'TRUE'
          # lockfile false : ne pas utiliser .github/pkg.lock
          # (le repo client est gÃ©nÃ©rÃ©, pas de lockfile versionnÃ©)
          # Sans Ã§a : erreur "cannot open connection" sur pkg.lock inexistant
          lockfile: false
          # Utiliser ralpha.fr/repo en prioritÃ© (Home Ã  jour) avant CRAN
          repos: |
            https://ralpha.fr/repo
            https://cloud.r-project.org

      - name: Build binary package
        id: build
        run: |
          R CMD INSTALL --build .
          BINARY=$(ls *.tgz 2>/dev/null | head -1)
          echo "binary_name=$BINARY" >> $GITHUB_OUTPUT
          echo "Built: $BINARY"

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: macos-arm-R${{ matrix.r-version }}
          path: "*.tgz"
          retention-days: 30

  # ============================================================================
  # Build macOS Binary (Intel x86_64) - multiple R versions
  # ============================================================================
  # NOTE: macos-12 retirÃ© (dÃ©c 2024), macos-13 retirÃ© (dÃ©c 2025)
  # Pour Intel, utiliser: macos-15-large, macos-14-large, ou macos-15-intel
  # Apple a arrÃªtÃ© le support Intel â€” GitHub retirera les runners Intel automne 2027
  # ============================================================================
  # NOTE: Intel builds are expensive ($0.12/min) - only build R 4.2
  # R 4.4+ users on Intel Mac can use ARM binaries via Rosetta 2
  build-macos-intel:
    needs: check-version
    if: needs.check-version.outputs.needs_macos_intel == 'true' || github.event_name == 'workflow_dispatch'
    runs-on: macos-15-large  # Intel x86_64 runner (paid)
    strategy:
      matrix:
        r-version: ['4.2']  # Only 4.2 - saves ~$10/run
      fail-fast: false

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup R ${{ matrix.r-version }}
        uses: r-lib/actions/setup-r@v2
        with:
          r-version: ${{ matrix.r-version }}

      # ----------------------------------------------------------------
      # Cache des dÃ©pendances R (r-lib)
      # ----------------------------------------------------------------
      # - ClÃ© de cache : OS + R version + hash(DESCRIPTION)
      # - Premier run : installe tout (~10-20 min), sauvegarde en cache
      # - Runs suivants : restaure le cache (~30s), skip installation
      # - InvalidÃ© auto si DESCRIPTION change (nouvelle dÃ©pendance)
      # ----------------------------------------------------------------
      - name: Install dependencies (with cache)
        uses: r-lib/actions/setup-r-dependencies@v2
        with:
          cache-version: 2
          extra-packages: any::rcmdcheck
          # pak-version devel : version dev de pak, plus robuste pour R 4.5+
          # (la version stable peut avoir des bugs avec les nouvelles versions R)
          pak-version: devel
          # upgrade TRUE : force la mise Ã  jour des packages mÃªme si une
          # version est dÃ©jÃ  installÃ©e (Ã©vite les conflits de versions)
          upgrade: 'TRUE'
          # lockfile false : ne pas utiliser .github/pkg.lock
          # (le repo client est gÃ©nÃ©rÃ©, pas de lockfile versionnÃ©)
          # Sans Ã§a : erreur "cannot open connection" sur pkg.lock inexistant
          lockfile: false
          # Utiliser ralpha.fr/repo en prioritÃ© (Home Ã  jour) avant CRAN
          repos: |
            https://ralpha.fr/repo
            https://cloud.r-project.org

      - name: Build binary package
        id: build
        run: |
          R CMD INSTALL --build .
          BINARY=$(ls *.tgz 2>/dev/null | head -1)
          echo "binary_name=$BINARY" >> $GITHUB_OUTPUT
          echo "Built: $BINARY (Intel x86_64)"

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: macos-intel-R${{ matrix.r-version }}
          path: "*.tgz"
          retention-days: 30

  # ============================================================================
  # Upload to FTP (ralpha.fr/repo) and Update PACKAGES Index
  # ============================================================================
  upload-to-ftp:
    needs: [check-version, build-windows, build-macos-arm, build-macos-intel]
    runs-on: ubuntu-latest
    # Run if at least one platform needs build, or if manually triggered
    if: |
      always() &&
      !cancelled() &&
      (
        needs.check-version.outputs.needs_windows == 'true' ||
        needs.check-version.outputs.needs_macos_arm == 'true' ||
        needs.check-version.outputs.needs_macos_intel == 'true' ||
        github.event_name == 'workflow_dispatch'
      )

    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts/

      - name: Setup R for index generation
        uses: r-lib/actions/setup-r@v2
        with:
          # âš ï¸ Must be a single version (string), NOT a list!
          # This step just generates PACKAGES index files, any R version works
          r-version: '4.4'

      - name: Download existing repo from FTP
        run: |
          # Install lftp
          sudo apt-get update && sudo apt-get install -y lftp

          # Download existing repo structure
          lftp -c "set ftp:ssl-allow no; open -u ${{ secrets.FTP_USER }},${{ secrets.FTP_PASSWORD }} ${{ secrets.FTP_HOST }}; mirror --verbose / existing_repo" || echo "No existing repo or connection failed"

      - name: Organize files into CRAN structure
        run: |
          mkdir -p repo

          # Copy existing repo content first (if exists)
          if [ -d "existing_repo" ]; then
            echo "=== Merging with existing repo ==="
            cp -r existing_repo/* repo/ 2>/dev/null || true
          fi

          # Organize Windows binaries (NEW builds)
          for R_VER in 4.2 4.4 4.5; do
            DIR="artifacts/windows-R${R_VER}"
            if [ -d "$DIR" ]; then
              mkdir -p "repo/bin/windows/contrib/${R_VER}"
              cp "$DIR"/*.zip "repo/bin/windows/contrib/${R_VER}/" 2>/dev/null || true
            fi
          done

          # Organize macOS ARM binaries (NEW builds)
          for R_VER in 4.2 4.4 4.5; do
            DIR="artifacts/macos-arm-R${R_VER}"
            if [ -d "$DIR" ]; then
              mkdir -p "repo/bin/macosx/big-sur-arm64/contrib/${R_VER}"
              cp "$DIR"/*.tgz "repo/bin/macosx/big-sur-arm64/contrib/${R_VER}/" 2>/dev/null || true
            fi
          done

          # Organize macOS Intel binaries (NEW builds)
          for R_VER in 4.2 4.4 4.5; do
            DIR="artifacts/macos-intel-R${R_VER}"
            if [ -d "$DIR" ]; then
              mkdir -p "repo/bin/macosx/big-sur-x86_64/contrib/${R_VER}"
              cp "$DIR"/*.tgz "repo/bin/macosx/big-sur-x86_64/contrib/${R_VER}/" 2>/dev/null || true
            fi
          done

          echo "=== Repository structure ==="
          find repo -type f | head -50

      - name: Generate PACKAGES index files (for ALL packages)
        run: |
          for R_VER in 4.2 4.4 4.5; do
            echo "=== Generating PACKAGES for R ${R_VER} ==="

            # Windows - regenerate index with ALL binaries present
            WIN_DIR="repo/bin/windows/contrib/${R_VER}"
            if [ -d "$WIN_DIR" ] && ls "$WIN_DIR"/*.zip 1>/dev/null 2>&1; then
              Rscript -e "tools::write_PACKAGES('${WIN_DIR}', type='win.binary')"
              echo "  Windows R${R_VER}: $(ls -1 $WIN_DIR/*.zip | wc -l) packages"
              echo "  Packages: $(ls -1 $WIN_DIR/*.zip | xargs -n1 basename)"
            fi

            # macOS ARM - regenerate index with ALL binaries present
            MAC_ARM_DIR="repo/bin/macosx/big-sur-arm64/contrib/${R_VER}"
            if [ -d "$MAC_ARM_DIR" ] && ls "$MAC_ARM_DIR"/*.tgz 1>/dev/null 2>&1; then
              Rscript -e "tools::write_PACKAGES('${MAC_ARM_DIR}', type='mac.binary')"
              echo "  macOS ARM R${R_VER}: $(ls -1 $MAC_ARM_DIR/*.tgz | wc -l) packages"
              echo "  Packages: $(ls -1 $MAC_ARM_DIR/*.tgz | xargs -n1 basename)"
            fi

            # macOS Intel - regenerate index with ALL binaries present
            MAC_INTEL_DIR="repo/bin/macosx/big-sur-x86_64/contrib/${R_VER}"
            if [ -d "$MAC_INTEL_DIR" ] && ls "$MAC_INTEL_DIR"/*.tgz 1>/dev/null 2>&1; then
              Rscript -e "tools::write_PACKAGES('${MAC_INTEL_DIR}', type='mac.binary')"
              echo "  macOS Intel R${R_VER}: $(ls -1 $MAC_INTEL_DIR/*.tgz | wc -l) packages"
              echo "  Packages: $(ls -1 $MAC_INTEL_DIR/*.tgz | xargs -n1 basename)"
            fi
          done

      - name: Upload to FTP
        run: |
          # Install lftp (more reliable than basic FTP)
          sudo apt-get update && sudo apt-get install -y lftp

          # Export credentials first
          export FTP_HOST="${{ secrets.FTP_HOST }}"
          export FTP_USER="${{ secrets.FTP_USER }}"
          export FTP_PASSWORD="${{ secrets.FTP_PASSWORD }}"
          export FTP_PATH="/"

          # Create lftp script (heredoc without quotes allows variable expansion)
          cat > upload.lftp << LFTP_SCRIPT
          set ftp:ssl-allow no
          set net:timeout 30
          set net:max-retries 3
          open -u $FTP_USER,$FTP_PASSWORD $FTP_HOST
          cd $FTP_PATH
          mirror --reverse --verbose repo/ .
          bye
          LFTP_SCRIPT

          # Execute upload
          lftp -f upload.lftp
          echo "Upload complete!"

      - name: Summary
        run: |
          echo "## Build Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Packages built:" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Platform | R Version | Package |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|-----------|---------|" >> $GITHUB_STEP_SUMMARY
          for f in $(find repo -name "*.zip" -o -name "*.tgz" | sort); do
            PLATFORM=$(echo $f | grep -q windows && echo "Windows" || echo "macOS ARM")
            R_VER=$(echo $f | grep -oP 'contrib/\K[0-9.]+')
            PKG=$(basename $f)
            echo "| $PLATFORM | $R_VER | $PKG |" >> $GITHUB_STEP_SUMMARY
          done
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Uploaded to: \`https://ralpha.fr/repo\`" >> $GITHUB_STEP_SUMMARY
