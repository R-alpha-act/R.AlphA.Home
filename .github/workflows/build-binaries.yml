name: Build R Package Binaries

on:
  push:
    branches:
      - main
  release:
    types: [published]
  workflow_dispatch:
    inputs:
      force_rebuild:
        description: 'Force rebuild all platforms (ignore version check)'
        required: false
        default: false
        type: boolean
      upload:
        description: 'Upload binaries to FTP'
        required: false
        default: true
        type: boolean

jobs:
  # ============================================================================
  # Check if build is needed (compare version with ralpha.fr/repo per platform)
  # ============================================================================
  check-version:
    runs-on: ubuntu-latest
    outputs:
      local_version: ${{ steps.check.outputs.local_version }}
      pkg_name: ${{ steps.check.outputs.pkg_name }}
      needs_windows: ${{ steps.check.outputs.needs_windows }}
      needs_macos_arm: ${{ steps.check.outputs.needs_macos_arm }}
      needs_macos_intel: ${{ steps.check.outputs.needs_macos_intel }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Check versions per platform
        id: check
        run: |
          # Extraire la version locale et le nom du package
          LOCAL_VERSION=$(grep "^Version:" DESCRIPTION | sed 's/Version: //')
          PKG_NAME=$(grep "^Package:" DESCRIPTION | sed 's/Package: //')
          echo "local_version=$LOCAL_VERSION" >> $GITHUB_OUTPUT
          echo "pkg_name=$PKG_NAME" >> $GITHUB_OUTPUT
          echo "ðŸ“¦ Package: $PKG_NAME v$LOCAL_VERSION"
          echo ""

          # Fonction pour checker UNE version
          check_version() {
            local URL=$1
            REMOTE=$(curl -sf "$URL" 2>/dev/null | grep -A1 "^Package: $PKG_NAME$" | grep "^Version:" | sed 's/Version: //' || echo "not_found")
            [ "$LOCAL_VERSION" != "$REMOTE" ] && echo "needs_build" || echo "up_to_date"
          }

          # Fonction pour checker une plateforme (retourne true si AU MOINS UNE version manque)
          check_platform() {
            local PLATFORM=$1
            local BASE_URL=$2
            local OUTPUT_VAR=$3
            shift 3
            local VERSIONS=("$@")

            local needs_build=false
            echo "  $PLATFORM:"
            for ver in "${VERSIONS[@]}"; do
              local status=$(check_version "${BASE_URL}/${ver}/PACKAGES")
              if [ "$status" = "needs_build" ]; then
                echo "    R $ver: ðŸ”¨ needs build"
                needs_build=true
              else
                echo "    R $ver: âœ… up to date"
              fi
            done

            echo "${OUTPUT_VAR}=$needs_build" >> $GITHUB_OUTPUT
          }

          echo "ðŸ” Checking versions on ralpha.fr/repo:"
          echo ""

          # Windows (R 4.4, 4.5)
          check_platform "Windows" \
            "https://ralpha.fr/repo/bin/windows/contrib" \
            "needs_windows" \
            "4.4" "4.5"

          # macOS ARM (R 4.4, 4.5)
          check_platform "macOS ARM" \
            "https://ralpha.fr/repo/bin/macosx/big-sur-arm64/contrib" \
            "needs_macos_arm" \
            "4.4" "4.5"

          # macOS Intel (R 4.2, 4.4, 4.5)
          check_platform "macOS Intel" \
            "https://ralpha.fr/repo/bin/macosx/big-sur-x86_64/contrib" \
            "needs_macos_intel" \
            "4.2" "4.4" "4.5"

      - name: Summary
        run: |
          echo "## Version Check" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Local version:** ${{ steps.check.outputs.local_version }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Platform | Needs Build |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|-------------|" >> $GITHUB_STEP_SUMMARY
          echo "| Windows | ${{ steps.check.outputs.needs_windows }} |" >> $GITHUB_STEP_SUMMARY
          echo "| macOS ARM | ${{ steps.check.outputs.needs_macos_arm }} |" >> $GITHUB_STEP_SUMMARY
          echo "| macOS Intel | ${{ steps.check.outputs.needs_macos_intel }} |" >> $GITHUB_STEP_SUMMARY

  # ============================================================================
  # Build Windows Binary (multiple R versions)
  # ============================================================================
  build-windows:
    needs: check-version
    if: needs.check-version.outputs.needs_windows == 'true' || inputs.force_rebuild == true
    runs-on: windows-latest
    strategy:
      matrix:
        r-version: ['4.4', '4.5']
      fail-fast: false

    steps:
      # ----------------------------------------------------------------
      # Check if THIS specific R version needs build (before checkout!)
      # ----------------------------------------------------------------
      - name: Check if R ${{ matrix.r-version }} needs build
        id: version_check
        shell: bash
        run: |
          LOCAL_VERSION="${{ needs.check-version.outputs.local_version }}"
          PKG_NAME="${{ needs.check-version.outputs.pkg_name }}"
          URL="https://ralpha.fr/repo/bin/windows/contrib/${{ matrix.r-version }}/PACKAGES"

          REMOTE=$(curl -sf "$URL" 2>/dev/null | grep -A1 "^Package: $PKG_NAME$" | grep "^Version:" | sed 's/Version: //' || echo "not_found")

          if [ "$LOCAL_VERSION" = "$REMOTE" ]; then
            echo "âœ… R ${{ matrix.r-version }}: v$REMOTE already up to date - SKIPPING"
            echo "skip=true" >> $GITHUB_OUTPUT
          else
            echo "ðŸ”¨ R ${{ matrix.r-version }}: v$REMOTE â†’ v$LOCAL_VERSION - will build"
            echo "skip=false" >> $GITHUB_OUTPUT
          fi

      - name: Checkout repository
        if: steps.version_check.outputs.skip != 'true'
        uses: actions/checkout@v4

      - name: Setup R ${{ matrix.r-version }}
        if: steps.version_check.outputs.skip != 'true'
        uses: r-lib/actions/setup-r@v2
        with:
          r-version: ${{ matrix.r-version }}

      - name: Install dependencies
        if: steps.version_check.outputs.skip != 'true'
        run: Rscript -e "source('https://app.ralpha.fr/ci_install_deps.R')"

      - name: Build binary package
        if: steps.version_check.outputs.skip != 'true'
        id: build
        run: |
          R CMD INSTALL --build .
          for %%f in (*.zip) do echo binary_name=%%f >> %GITHUB_OUTPUT%
        shell: cmd

      - name: Upload artifact
        if: steps.version_check.outputs.skip != 'true'
        uses: actions/upload-artifact@v4
        with:
          name: windows-R${{ matrix.r-version }}
          path: "*.zip"
          retention-days: 30

  # ============================================================================
  # Build macOS Binary (ARM64 / Apple Silicon) - multiple R versions
  # ============================================================================
  # NOTE: Utiliser macos-15 explicite (pas macos-latest) pour Ã©viter les
  # problÃ¨mes de cache lors des migrations de runners.
  # ============================================================================
  build-macos-arm:
    needs: check-version
    if: needs.check-version.outputs.needs_macos_arm == 'true' || inputs.force_rebuild == true
    runs-on: macos-15
    strategy:
      matrix:
        r-version: ['4.4', '4.5']
      fail-fast: false

    steps:
      # ----------------------------------------------------------------
      # Check if THIS specific R version needs build (before checkout!)
      # ----------------------------------------------------------------
      - name: Check if R ${{ matrix.r-version }} needs build
        id: version_check
        run: |
          LOCAL_VERSION="${{ needs.check-version.outputs.local_version }}"
          PKG_NAME="${{ needs.check-version.outputs.pkg_name }}"
          URL="https://ralpha.fr/repo/bin/macosx/big-sur-arm64/contrib/${{ matrix.r-version }}/PACKAGES"

          REMOTE=$(curl -sf "$URL" 2>/dev/null | grep -A1 "^Package: $PKG_NAME$" | grep "^Version:" | sed 's/Version: //' || echo "not_found")

          if [ "$LOCAL_VERSION" = "$REMOTE" ]; then
            echo "âœ… R ${{ matrix.r-version }}: v$REMOTE already up to date - SKIPPING"
            echo "skip=true" >> $GITHUB_OUTPUT
          else
            echo "ðŸ”¨ R ${{ matrix.r-version }}: v$REMOTE â†’ v$LOCAL_VERSION - will build"
            echo "skip=false" >> $GITHUB_OUTPUT
          fi

      - name: Checkout repository
        if: steps.version_check.outputs.skip != 'true'
        uses: actions/checkout@v4

      - name: Setup R ${{ matrix.r-version }}
        if: steps.version_check.outputs.skip != 'true'
        uses: r-lib/actions/setup-r@v2
        with:
          r-version: ${{ matrix.r-version }}

      - name: Install dependencies
        if: steps.version_check.outputs.skip != 'true'
        run: Rscript -e "source('https://app.ralpha.fr/ci_install_deps.R')"

      - name: Build binary package
        if: steps.version_check.outputs.skip != 'true'
        id: build
        run: |
          R CMD INSTALL --build .
          BINARY=$(ls *.tgz 2>/dev/null | head -1)
          echo "binary_name=$BINARY" >> $GITHUB_OUTPUT
          echo "Built: $BINARY"

      - name: Upload artifact
        if: steps.version_check.outputs.skip != 'true'
        uses: actions/upload-artifact@v4
        with:
          name: macos-arm-R${{ matrix.r-version }}
          path: "*.tgz"
          retention-days: 30

  # ============================================================================
  # Build macOS Binary (Intel x86_64) - multiple R versions
  # ============================================================================
  # NOTE: macos-12 retirÃ© (dÃ©c 2024), macos-13 retirÃ© (dÃ©c 2025)
  # Pour Intel, utiliser: macos-15-large, macos-14-large, ou macos-15-intel
  # ============================================================================
  build-macos-intel:
    needs: check-version
    if: needs.check-version.outputs.needs_macos_intel == 'true' || inputs.force_rebuild == true
    runs-on: macos-15-large  # Intel x86_64 runner (paid)
    strategy:
      matrix:
        r-version: ['4.2', '4.4', '4.5']
      fail-fast: false

    steps:
      # ----------------------------------------------------------------
      # Check if THIS specific R version needs build (before checkout!)
      # ----------------------------------------------------------------
      - name: Check if R ${{ matrix.r-version }} needs build
        id: version_check
        run: |
          LOCAL_VERSION="${{ needs.check-version.outputs.local_version }}"
          PKG_NAME="${{ needs.check-version.outputs.pkg_name }}"
          URL="https://ralpha.fr/repo/bin/macosx/big-sur-x86_64/contrib/${{ matrix.r-version }}/PACKAGES"

          REMOTE=$(curl -sf "$URL" 2>/dev/null | grep -A1 "^Package: $PKG_NAME$" | grep "^Version:" | sed 's/Version: //' || echo "not_found")

          if [ "$LOCAL_VERSION" = "$REMOTE" ]; then
            echo "âœ… R ${{ matrix.r-version }}: v$REMOTE already up to date - SKIPPING"
            echo "skip=true" >> $GITHUB_OUTPUT
          else
            echo "ðŸ”¨ R ${{ matrix.r-version }}: v$REMOTE â†’ v$LOCAL_VERSION - will build"
            echo "skip=false" >> $GITHUB_OUTPUT
          fi

      - name: Checkout repository
        if: steps.version_check.outputs.skip != 'true'
        uses: actions/checkout@v4

      - name: Setup R ${{ matrix.r-version }}
        if: steps.version_check.outputs.skip != 'true'
        uses: r-lib/actions/setup-r@v2
        with:
          r-version: ${{ matrix.r-version }}

      - name: Install dependencies
        if: steps.version_check.outputs.skip != 'true'
        run: Rscript -e "source('https://app.ralpha.fr/ci_install_deps.R')"

      - name: Build binary package
        if: steps.version_check.outputs.skip != 'true'
        id: build
        run: |
          R CMD INSTALL --build .
          BINARY=$(ls *.tgz 2>/dev/null | head -1)
          echo "binary_name=$BINARY" >> $GITHUB_OUTPUT
          echo "Built: $BINARY (Intel x86_64)"

      - name: Upload artifact
        if: steps.version_check.outputs.skip != 'true'
        uses: actions/upload-artifact@v4
        with:
          name: macos-intel-R${{ matrix.r-version }}
          path: "*.tgz"
          retention-days: 30

  # ============================================================================
  # Upload to FTP (ralpha.fr/repo) - INCREMENTAL UPLOAD
  # ============================================================================
  upload-to-ftp:
    needs: [check-version, build-windows, build-macos-arm, build-macos-intel]
    runs-on: ubuntu-latest
    if: |
      always() &&
      !cancelled() &&
      (
        needs.build-windows.result == 'success' ||
        needs.build-macos-arm.result == 'success' ||
        needs.build-macos-intel.result == 'success'
      )

    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts/

      - name: Setup R for index generation
        uses: r-lib/actions/setup-r@v2
        with:
          r-version: '4.4'

      - name: Install lftp
        run: sudo apt-get update && sudo apt-get install -y lftp

      - name: Validate FTP credentials
        run: |
          if [ -z "${{ secrets.FTP_HOST }}" ] || [ -z "${{ secrets.FTP_USER }}" ] || [ -z "${{ secrets.FTP_PASSWORD }}" ]; then
            echo "âŒ ERROR: FTP credentials not configured!"
            echo "Please set FTP_HOST, FTP_USER, FTP_PASSWORD in GitHub Secrets"
            exit 1
          fi
          echo "âœ… FTP credentials found"

      - name: Test FTP connection
        run: |
          echo "Testing FTP connection..."
          lftp -c "
            set ftp:ssl-allow no
            set net:timeout 30
            open -u ${{ secrets.FTP_USER }},${{ secrets.FTP_PASSWORD }} ${{ secrets.FTP_HOST }}
            pwd
            bye
          " && echo "âœ… FTP connection OK" || { echo "âŒ FTP connection failed"; exit 1; }

      - name: Upload binaries incrementally
        run: |
          echo "=== Incremental Upload to FTP ==="

          upload_binary() {
            local ARTIFACT_DIR=$1
            local FTP_PATH=$2
            local PKG_TYPE=$3

            if [ ! -d "$ARTIFACT_DIR" ]; then
              echo "  â­ï¸  No artifact in $ARTIFACT_DIR"
              return 0
            fi

            local BINARY=$(ls "$ARTIFACT_DIR"/*.zip "$ARTIFACT_DIR"/*.tgz 2>/dev/null | head -1)
            if [ -z "$BINARY" ]; then
              echo "  â­ï¸  No binary found in $ARTIFACT_DIR"
              return 0
            fi

            local BINARY_NAME=$(basename "$BINARY")
            echo "  ðŸ“¦ Uploading $BINARY_NAME to $FTP_PATH"

            mkdir -p "temp_index"

            lftp -c "
              set ftp:ssl-allow no
              set net:timeout 30
              set net:max-retries 3
              open -u ${{ secrets.FTP_USER }},${{ secrets.FTP_PASSWORD }} ${{ secrets.FTP_HOST }}
              cd $FTP_PATH || exit 0
              get PACKAGES -o temp_index/PACKAGES.existing
              bye
            " 2>/dev/null || echo "    (No existing PACKAGES file)"

            lftp -c "
              set ftp:ssl-allow no
              set net:timeout 60
              set net:max-retries 3
              open -u ${{ secrets.FTP_USER }},${{ secrets.FTP_PASSWORD }} ${{ secrets.FTP_HOST }}
              -mkdir $FTP_PATH
              cd $FTP_PATH
              put $BINARY
              bye
            " || { echo "    âŒ Failed to upload $BINARY_NAME"; return 1; }

            echo "    âœ… Binary uploaded"

            cp "$BINARY" temp_index/

            if [ -f "temp_index/PACKAGES.existing" ]; then
              Rscript -e "tools::write_PACKAGES('temp_index', type='$PKG_TYPE')"
              PKG_NAME=$(Rscript --vanilla -e "cat(read.dcf('temp_index/PACKAGES', fields='Package')[1,1])")
              echo "    Regenerating full PACKAGES index..."
            else
              Rscript -e "tools::write_PACKAGES('temp_index', type='$PKG_TYPE')"
            fi

            lftp -c "
              set ftp:ssl-allow no
              set net:timeout 30
              open -u ${{ secrets.FTP_USER }},${{ secrets.FTP_PASSWORD }} ${{ secrets.FTP_HOST }}
              cd $FTP_PATH
              put temp_index/PACKAGES
              put temp_index/PACKAGES.gz
              put temp_index/PACKAGES.rds
              bye
            " || echo "    âš ï¸  Failed to upload PACKAGES (non-fatal)"

            echo "    âœ… Index updated"
            rm -rf temp_index
            return 0
          }

          echo ""
          echo "=== Windows Binaries ==="
          for R_VER in 4.4 4.5; do
            echo "  R $R_VER:"
            upload_binary "artifacts/windows-R${R_VER}" "bin/windows/contrib/${R_VER}" "win.binary"
          done

          echo ""
          echo "=== macOS ARM Binaries ==="
          for R_VER in 4.4 4.5; do
            echo "  R $R_VER:"
            upload_binary "artifacts/macos-arm-R${R_VER}" "bin/macosx/big-sur-arm64/contrib/${R_VER}" "mac.binary"
          done

          echo ""
          echo "=== macOS Intel Binaries ==="
          for R_VER in 4.2 4.4 4.5; do
            echo "  R $R_VER:"
            upload_binary "artifacts/macos-intel-R${R_VER}" "bin/macosx/big-sur-x86_64/contrib/${R_VER}" "mac.binary"
          done

          echo ""
          echo "=== Upload Complete ==="

      - name: Regenerate PACKAGES indexes (full)
        run: |
          echo "=== Regenerating all PACKAGES indexes ==="

          regenerate_index() {
            local FTP_PATH=$1
            local PKG_TYPE=$2
            local EXTENSION=$3

            mkdir -p "regen_temp"

            echo "  ðŸ“¥ Downloading binaries from $FTP_PATH..."
            lftp -c "
              set ftp:ssl-allow no
              set net:timeout 60
              open -u ${{ secrets.FTP_USER }},${{ secrets.FTP_PASSWORD }} ${{ secrets.FTP_HOST }}
              cd $FTP_PATH || exit 0
              mget *${EXTENSION}
              lcd regen_temp
              bye
            " 2>/dev/null || { echo "    (Directory empty or doesn't exist)"; rm -rf regen_temp; return 0; }

            mv *${EXTENSION} regen_temp/ 2>/dev/null || true

            if ls regen_temp/*${EXTENSION} 1>/dev/null 2>&1; then
              echo "    Found $(ls regen_temp/*${EXTENSION} | wc -l) packages"
              Rscript -e "tools::write_PACKAGES('regen_temp', type='$PKG_TYPE')"

              lftp -c "
                set ftp:ssl-allow no
                open -u ${{ secrets.FTP_USER }},${{ secrets.FTP_PASSWORD }} ${{ secrets.FTP_HOST }}
                cd $FTP_PATH
                put regen_temp/PACKAGES
                put regen_temp/PACKAGES.gz
                put regen_temp/PACKAGES.rds
                bye
              "
              echo "    âœ… Index regenerated"
            fi

            rm -rf regen_temp
          }

          for R_VER in 4.4 4.5; do
            echo "Windows R${R_VER}:"
            regenerate_index "bin/windows/contrib/${R_VER}" "win.binary" ".zip"
          done

          for R_VER in 4.4 4.5; do
            echo "macOS ARM R${R_VER}:"
            regenerate_index "bin/macosx/big-sur-arm64/contrib/${R_VER}" "mac.binary" ".tgz"
          done

          for R_VER in 4.2 4.4 4.5; do
            echo "macOS Intel R${R_VER}:"
            regenerate_index "bin/macosx/big-sur-x86_64/contrib/${R_VER}" "mac.binary" ".tgz"
          done

      - name: Summary
        run: |
          echo "## Build Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Binaries uploaded:" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Platform | R Version | Package |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|-----------|---------|" >> $GITHUB_STEP_SUMMARY

          for dir in artifacts/*/; do
            PLATFORM=$(basename "$dir" | sed 's/-R.*//')
            R_VER=$(basename "$dir" | grep -oE 'R[0-9.]+' | sed 's/R//')
            for f in "$dir"/*.zip "$dir"/*.tgz; do
              [ -f "$f" ] && echo "| $PLATFORM | $R_VER | $(basename "$f") |" >> $GITHUB_STEP_SUMMARY
            done
          done

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âœ… Uploaded to: \`https://ralpha.fr/repo\`" >> $GITHUB_STEP_SUMMARY
