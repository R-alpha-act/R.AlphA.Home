name: Build R Package Binaries

on:
  push:
    branches:
      - main
  release:
    types: [published]
  workflow_dispatch:
    inputs:
      upload:
        description: 'Upload binaries to FTP'
        required: false
        default: 'true'
        type: boolean

jobs:
  # ============================================================================
  # Build Windows Binary (multiple R versions)
  # ============================================================================
  build-windows:
    runs-on: windows-latest
    strategy:
      matrix:
        r-version: ['4.3', '4.4', '4.5']
      fail-fast: false

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup R ${{ matrix.r-version }}
        uses: r-lib/actions/setup-r@v2
        with:
          r-version: ${{ matrix.r-version }}

      - name: Install dependencies
        run: |
          install.packages('remotes')
          remotes::install_deps(dependencies = TRUE)
        shell: Rscript {0}

      - name: Build binary package
        id: build
        run: |
          R CMD INSTALL --build .
          for %%f in (*.zip) do echo binary_name=%%f >> %GITHUB_OUTPUT%
        shell: cmd

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: windows-R${{ matrix.r-version }}
          path: "*.zip"
          retention-days: 30

  # ============================================================================
  # Build macOS Binary (ARM64 / Apple Silicon) - multiple R versions
  # ============================================================================
  build-macos-arm:
    runs-on: macos-latest
    strategy:
      matrix:
        r-version: ['4.3', '4.4', '4.5']
      fail-fast: false

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup R ${{ matrix.r-version }}
        uses: r-lib/actions/setup-r@v2
        with:
          r-version: ${{ matrix.r-version }}

      - name: Install dependencies
        run: |
          install.packages('remotes')
          remotes::install_deps(dependencies = TRUE)
        shell: Rscript {0}

      - name: Build binary package
        id: build
        run: |
          R CMD INSTALL --build .
          BINARY=$(ls *.tgz 2>/dev/null | head -1)
          echo "binary_name=$BINARY" >> $GITHUB_OUTPUT
          echo "Built: $BINARY"

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: macos-arm-R${{ matrix.r-version }}
          path: "*.tgz"
          retention-days: 30

  # ============================================================================
  # Upload to FTP (ralpha.fr/repo) and Update PACKAGES Index
  # ============================================================================
  upload-to-ftp:
    needs: [build-windows, build-macos-arm]
    runs-on: ubuntu-latest
    if: (!cancelled()) && (github.event_name == 'release' || github.event_name == 'push' || github.event.inputs.upload == 'true')

    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts/

      - name: Setup R for index generation
        uses: r-lib/actions/setup-r@v2
        with:
          r-version: ['4.3', '4.4', '4.5']

      - name: Organize files into CRAN structure
        run: |
          mkdir -p repo

          # Organize Windows binaries
          for R_VER in 4.3 4.4 4.5; do
            DIR="artifacts/windows-R${R_VER}"
            if [ -d "$DIR" ]; then
              mkdir -p "repo/bin/windows/contrib/${R_VER}"
              cp "$DIR"/*.zip "repo/bin/windows/contrib/${R_VER}/" 2>/dev/null || true
            fi
          done

          # Organize macOS ARM binaries
          for R_VER in 4.3 4.4 4.5; do
            DIR="artifacts/macos-arm-R${R_VER}"
            if [ -d "$DIR" ]; then
              mkdir -p "repo/bin/macosx/big-sur-arm64/contrib/${R_VER}"
              cp "$DIR"/*.tgz "repo/bin/macosx/big-sur-arm64/contrib/${R_VER}/" 2>/dev/null || true
            fi
          done

          echo "=== Repository structure ==="
          find repo -type f | head -50

      - name: Generate PACKAGES index files
        run: |
          for R_VER in 4.3 4.4 4.5; do
            echo "=== Generating PACKAGES for R ${R_VER} ==="

            # Windows
            WIN_DIR="repo/bin/windows/contrib/${R_VER}"
            if [ -d "$WIN_DIR" ] && ls "$WIN_DIR"/*.zip 1>/dev/null 2>&1; then
              Rscript -e "tools::write_PACKAGES('${WIN_DIR}', type='win.binary')"
              echo "  Windows R${R_VER}: $(ls -1 $WIN_DIR/*.zip | wc -l) packages"
            fi

            # macOS ARM
            MAC_DIR="repo/bin/macosx/big-sur-arm64/contrib/${R_VER}"
            if [ -d "$MAC_DIR" ] && ls "$MAC_DIR"/*.tgz 1>/dev/null 2>&1; then
              Rscript -e "tools::write_PACKAGES('${MAC_DIR}', type='mac.binary')"
              echo "  macOS ARM R${R_VER}: $(ls -1 $MAC_DIR/*.tgz | wc -l) packages"
            fi
          done

      - name: Upload to FTP
        run: |
          # Install lftp (more reliable than basic FTP)
          sudo apt-get update && sudo apt-get install -y lftp

          # Export credentials first
          export FTP_HOST="${{ secrets.FTP_HOST }}"
          export FTP_USER="${{ secrets.FTP_USER }}"
          export FTP_PASSWORD="${{ secrets.FTP_PASSWORD }}"
          export FTP_PATH="/"

          # Create lftp script (heredoc without quotes allows variable expansion)
          cat > upload.lftp << LFTP_SCRIPT
          set ftp:ssl-allow no
          set net:timeout 30
          set net:max-retries 3
          open -u $FTP_USER,$FTP_PASSWORD $FTP_HOST
          cd $FTP_PATH
          mirror --reverse --delete --verbose repo/ .
          bye
          LFTP_SCRIPT

          # Execute upload
          lftp -f upload.lftp
          echo "Upload complete!"

      - name: Summary
        run: |
          echo "## Build Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Packages built:" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Platform | R Version | Package |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|-----------|---------|" >> $GITHUB_STEP_SUMMARY
          for f in $(find repo -name "*.zip" -o -name "*.tgz" | sort); do
            PLATFORM=$(echo $f | grep -q windows && echo "Windows" || echo "macOS ARM")
            R_VER=$(echo $f | grep -oP 'contrib/\K[0-9.]+')
            PKG=$(basename $f)
            echo "| $PLATFORM | $R_VER | $PKG |" >> $GITHUB_STEP_SUMMARY
          done
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Uploaded to: \`https://ralpha.fr/repo\`" >> $GITHUB_STEP_SUMMARY
